name: volumio
version: '0.1'
summary: The audiophile music player
description: |
  Volumio is an headless audiophile music player, designed to play music with
  the highest possible fidelity. Enjoy your music as you never did before!

grade: devel
confinement: devmode

apps:
  backend:
    command: bin/node $SNAP/lib/node_modules/Volumio2/index.js
    environment:
      DATADIR: $SNAP_COMMON
      BASEDIR: $SNAP/lib/node_modules/Volumio2
      MPD_SOCKET_PATH: /tmp/mpdsocket
      ARCH: $SNAP_ARCH
      ALSA_CONFIG_PATH: $SNAP/etc/alsa.conf
      LD_LIBRARY_PATH: $SNAP/usr/lib/alsa-lib:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio:$LD_LIBRARY_PATH
    plugs:
      - pulseaudio
  mpd:
    command: usr/bin/mpd $SNAP/etc/mpd.conf
    environment:
      DATADIR: $SNAP_COMMON
      BASEDIR: $SNAP/lib/node_modules/Volumio2
      ARCH: $SNAP_ARCH
      LD_LIBRARY_PATH: $LD_LIBRARY_PATH:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/samba:$SNAP/usr/lib/alsa-lib:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio
    plugs:
      - pulseaudio
parts:
  mpd-conf:
    plugin: dump
    source:  snap/local
    organize:
      "mpd.conf": "etc/mpd.conf"
  node-modules:
    plugin: dump
    source: http://repo.volumio.org/Volumio2/node_modules_x64.tar.gz
    organize:
      "*": lib/node_modules/Volumio2/node_modules/
  dependencies:
    plugin: nil
    stage-packages:
    - mpd
    stage:
      - -usr/share/alsa/alsa.conf
      - -usr/share/alsa/cards/USB-Audio.conf
      - -usr/share/alsa/cards/aliases.conf
      - -usr/share/alsa/pcm/dmix.conf
      - -usr/share/alsa/pcm/dsnoop.conf
      - -usr/share/alsa/pcm/surround21.conf
      - -usr/share/alsa/pcm/surround40.conf
      - -usr/share/alsa/pcm/surround41.conf
      - -usr/share/alsa/pcm/surround50.conf
      - -usr/share/alsa/pcm/surround51.conf
      - -usr/share/alsa/pcm/surround71.conf
      - -etc/mpd.conf
  volumio-backend:
    plugin: dump
    source: .
    organize:
      "*": lib/node_modules/Volumio2/
      ".*": lib/node_modules/Volumio2/
    build-packages:
      # Build tools
      - g++
      - make
      - python-minimal
      - git

      # Libs
      - libavahi-compat-libdnssd-dev
      - libncurses5-dev
      # specify remote part build order
    after:
    - alsa
  volumio-ui:
    plugin: dump
    source: https://github.com/volumio/Volumio2-UI/archive/dist.zip
    organize:
      "Volumio2-UI-dist": lib/node_modules/Volumio2/http/www
  alsa:
     after: [alsa-lib, alsa-plugins]
  alsa-lib:
     # configflags needed until LP#1766878 is fixed
    configflags:
     - --prefix=/usr
     - --sysconfdir=/etc
     - --libexec=/usr/lib
     - --libdir=/usr/lib
     - --localstatedir=/var
     - --with-configdir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/share/alsa
     - --with-plugindir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/lib/alsa-lib
     - --disable-alisp
     - --disable-aload
     - --disable-python
     - --disable-rawmidi
     - --disable-static
     - --disable-topology
     - --disable-ucm
     - --enable-symbolic-functions
  alsa-plugins:
    after: [alsa-lib]
    # configflags needed until LP#1766878 is fixed
    configflags:
    - --prefix=/usr
    - --sysconfdir=/etc
    - --libexec=/usr/lib
    - --libdir=/usr/lib
    - --localstatedir=/var
    - --disable-arcamav
    - --disable-avcodec
    - --disable-jack
    - --disable-mix
    - --disable-oss
    - --disable-usbstream
    - --with-plugindir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/lib/alsa-lib
    - --disable-static
    - LDFLAGS=-L$SNAPCRAFT_STAGE/usr/lib
  alsa-utils:
    after: [alsa-lib]
    plugin: autotools
    source: https://ftp.osuosl.org/pub/blfs/conglomeration/alsa-utils/alsa-utils-1.1.6.tar.bz2
    configflags:
    - --prefix=/usr
    - --with-alsa-prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/
    - --sysconfdir=/etc
    - --libexec=/usr/lib
    - --libdir=/usr/lib
    - --localstatedir=/var
    - --disable-static
    - --disable-nls
    - LDFLAGS=-L$SNAPCRAFT_STAGE/usr/lib
    organize:
      snap/$SNAPCRAFT_PROJECT_NAME/current/usr/lib/*: usr/lib
      snap/$SNAPCRAFT_PROJECT_NAME/current/usr/bin/*: usr/bin
  nodejs:
    plugin: dump
    source: https://nodejs.org/dist/v8.11.0/node-v8.11.0-linux-x64.tar.gz
